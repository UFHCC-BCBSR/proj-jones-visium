---
title: "10x Visium FFPE Space Ranger QC Report"
author: "QC Analysis"
date: "`r Sys.Date()`"
output:
  html_document:
    toc: true
    toc_float: true
    toc_depth: 3
    theme: flatly
    code_folding: hide
    df_print: paged
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE, warning = FALSE, message = FALSE, fig.width = 10, fig.height = 6)
```

```{r load-libraries}
library(tidyverse)
library(DT)
library(plotly)
library(knitr)
library(kableExtra)
```

# Overview

This report analyzes quality control metrics for 10x Visium FFPE samples processed with Space Ranger using probe-based gene expression detection. FFPE samples have different expected QC thresholds compared to fresh frozen due to RNA fragmentation and cross-linking during formalin fixation.

**Reference:** 10x Genomics Technical Note CG000408 Rev C "Visium Spatial Gene Expression Reagent Kits for FFPE - User Guide" and CG000495 "Interpreting Space Ranger Web Summary Files for Visium Spatial Gene Expression for FFPE"

```{r load-data}
metrics <- read.csv("../data/combined_metrics_summary.csv", stringsAsFactors = FALSE)
metrics <- metrics %>% filter(`Sample.ID` != "tiny")
n_samples <- nrow(metrics)
```

**Total Samples Analyzed:** `r n_samples`

**Sample IDs:** `r paste(metrics$Sample.ID, collapse = ", ")`

---

# Interactive Data Table

```{r interactive-table}
key_metrics <- metrics %>%
  select(
    `Sample ID` = Sample.ID,
    `Spots Under Tissue` = Number.of.Spots.Under.Tissue,
    `Median Genes/Spot` = Median.Genes.per.Spot,
    `Median UMI/Spot` = Median.UMI.Counts.per.Spot,
    `Mean Reads/Spot` = Mean.Reads.per.Spot,
    `Genes Detected` = Genes.Detected,
    `Seq Saturation` = Sequencing.Saturation,
    `Reads Confidently Mapped` = Reads.Mapped.Confidently.to.Probe.Set,
    `Split-Mapped Reads` = Reads.Split.Mapped.to.Probe.Set
  ) %>%
  mutate(
    `Mean Reads/Spot` = round(`Mean Reads/Spot`, 0),
    `Seq Saturation` = round(`Seq Saturation` * 100, 2),
    `Reads Confidently Mapped` = round(`Reads Confidently Mapped` * 100, 2),
    `Split-Mapped Reads` = round(`Split-Mapped Reads` * 100, 2)
  )

datatable(key_metrics, 
          options = list(pageLength = 10, scrollX = TRUE),
          rownames = FALSE)
```

---

# Metric-by-Metric Analysis

## 1. Median UMI Counts per Spot

### Technical Definition

**Molecular Process:** During the Visium FFPE workflow, gene-specific probes hybridize to target mRNA sequences within tissue sections. Each mRNA molecule is tagged with a unique molecular identifier (UMI) - a random barcode sequence that allows computational deduplication of PCR amplification products. After probe ligation, extension, and sequencing, reads are collapsed by their UMI to count individual mRNA molecules, not PCR duplicates.

**What This Metric Measures:** The median number of unique mRNA molecules successfully captured, reverse transcribed, and sequenced per spatial spot (55 micron diameter containing approximately 0-10 cells depending on tissue type and cell density).

**Biological Interpretation:** This metric reflects the combination of: (1) endogenous mRNA abundance in the tissue, (2) mRNA preservation during FFPE processing, (3) probe accessibility after deparaffinization and decrosslinking, (4) efficiency of probe hybridization and ligation, and (5) library preparation efficiency.

**FFPE-Specific Considerations:** Formalin fixation creates methylene bridges between nucleic acids and proteins, reducing RNA accessibility. Extended fixation times, suboptimal deparaffinization, or incomplete protease digestion result in reduced probe access to target sequences, yielding lower UMI counts. FFPE RNA is also fragmented, though probe-based detection specifically targets shorter sequences (50-100 nucleotides) to accommodate this.

### Quality Thresholds for FFPE with Probes

Based on 10x Genomics Technical Note CG000495:

- **Excellent:** >2,000 UMIs/spot
- **Good:** 1,000-2,000 UMIs/spot  
- **Marginal:** 500-1,000 UMIs/spot
- **Failed:** <500 UMIs/spot

```{r median-umi}
p1 <- ggplot(metrics, aes(x = reorder(Sample.ID, Median.UMI.Counts.per.Spot), 
                           y = Median.UMI.Counts.per.Spot, fill = Sample.ID)) +
  geom_bar(stat = "identity", show.legend = FALSE) +
  geom_hline(yintercept = 2000, linetype = "dashed", color = "darkgreen", size = 1) +
  geom_hline(yintercept = 1000, linetype = "dashed", color = "orange", size = 1) +
  geom_hline(yintercept = 500, linetype = "dashed", color = "red", size = 1) +
  geom_text(aes(label = round(Median.UMI.Counts.per.Spot, 0)), vjust = -0.5, size = 3) +
  labs(title = "Median UMI Counts per Spot (FFPE)",
       subtitle = "Green = 2,000 (Excellent) | Orange = 1,000 (Good) | Red = 500 (Marginal)",
       x = "Sample", y = "Median UMI Counts") +
  theme_minimal() +
  theme(axis.text.x = element_text(angle = 45, hjust = 1))

ggplotly(p1)
```

```{r umi-assessment}
umi_assessment <- metrics %>%
  mutate(
    UMI_Status = case_when(
      Median.UMI.Counts.per.Spot >= 2000 ~ "Excellent",
      Median.UMI.Counts.per.Spot >= 1000 ~ "Good",
      Median.UMI.Counts.per.Spot >= 500 ~ "Marginal",
      TRUE ~ "Failed"
    )
  ) %>%
  select(Sample.ID, Median.UMI.Counts.per.Spot, UMI_Status)

kable(umi_assessment, 
      col.names = c("Sample", "Median UMI/Spot", "Status"),
      align = c("l", "r", "l")) %>%
  kable_styling(bootstrap_options = c("striped", "hover")) %>%
  row_spec(which(umi_assessment$UMI_Status == "Failed"), background = "#f8d7da") %>%
  row_spec(which(umi_assessment$UMI_Status == "Marginal"), background = "#fff3cd") %>%
  row_spec(which(umi_assessment$UMI_Status == "Good"), background = "#d1ecf1") %>%
  row_spec(which(umi_assessment$UMI_Status == "Excellent"), background = "#d4edda")
```

### Troubleshooting Low UMI Counts

**Tissue-Level Causes:**
- Extended formalin fixation time (>48 hours optimal, >72 hours problematic)
- Improper tissue processing (inadequate dehydration, incomplete paraffin infiltration)
- RNA degradation pre-fixation (delayed fixation after excision)
- Low-cellularity regions (adipose, necrotic areas, stromal regions)

**Technical Causes:**
- Incomplete deparaffinization (residual paraffin blocks probe access)
- Insufficient protease treatment (inadequate decrosslinking reduces RNA accessibility)
- Probe degradation or hybridization failure
- Low-quality FFPE block (storage conditions, age of block)

---

## 2. Median Genes per Spot

### Technical Definition

**Molecular Process:** Each probe pair in the panel targets a specific gene. After probe hybridization, ligation, and sequencing, genes are considered "detected" if at least one UMI is identified. The median genes per spot represents the transcriptional complexity captured in each spatial location.

**What This Metric Measures:** The median number of distinct gene loci with at least 1 UMI detected per spot. This reflects both the biological diversity of gene expression and the technical success of capturing that diversity.

**Biological Interpretation:** Gene count per spot depends on: (1) cell number per spot (0-10 cells), (2) cell type diversity within the spot, (3) transcriptional activity of cells, (4) probe panel composition (typically 18,000-19,000 genes in human panels), and (5) RNA quality and accessibility.

**Relationship to UMI Counts:** While UMI counts measure transcript abundance, gene counts measure transcriptional diversity. A spot with 1,000 UMIs could have 100 genes (10 UMIs each, low diversity) or 500 genes (2 UMIs each, high diversity). FFPE samples typically show proportionally lower gene counts than UMI counts due to dropout of weakly expressed genes.

### Quality Thresholds for FFPE with Probes

Based on 10x Genomics data and published FFPE Visium studies:

- **Excellent:** >1,500 genes/spot
- **Good:** 1,000-1,500 genes/spot
- **Marginal:** 500-1,000 genes/spot  
- **Failed:** <500 genes/spot

```{r median-genes}
p2 <- ggplot(metrics, aes(x = reorder(Sample.ID, Median.Genes.per.Spot), 
                           y = Median.Genes.per.Spot, fill = Sample.ID)) +
  geom_bar(stat = "identity", show.legend = FALSE) +
  geom_hline(yintercept = 1500, linetype = "dashed", color = "darkgreen", size = 1) +
  geom_hline(yintercept = 1000, linetype = "dashed", color = "orange", size = 1) +
  geom_hline(yintercept = 500, linetype = "dashed", color = "red", size = 1) +
  geom_text(aes(label = round(Median.Genes.per.Spot, 0)), vjust = -0.5, size = 3) +
  labs(title = "Median Genes per Spot (FFPE)",
       subtitle = "Green = 1,500 (Excellent) | Orange = 1,000 (Good) | Red = 500 (Marginal)",
       x = "Sample", y = "Median Genes Detected") +
  theme_minimal() +
  theme(axis.text.x = element_text(angle = 45, hjust = 1))

ggplotly(p2)
```

```{r genes-assessment}
genes_assessment <- metrics %>%
  mutate(
    Genes_Status = case_when(
      Median.Genes.per.Spot >= 1500 ~ "Excellent",
      Median.Genes.per.Spot >= 1000 ~ "Good",
      Median.Genes.per.Spot >= 500 ~ "Marginal",
      TRUE ~ "Failed"
    )
  ) %>%
  select(Sample.ID, Median.Genes.per.Spot, Genes_Status)

kable(genes_assessment, 
      col.names = c("Sample", "Median Genes/Spot", "Status"),
      align = c("l", "r", "l")) %>%
  kable_styling(bootstrap_options = c("striped", "hover")) %>%
  row_spec(which(genes_assessment$Genes_Status == "Failed"), background = "#f8d7da") %>%
  row_spec(which(genes_assessment$Genes_Status == "Marginal"), background = "#fff3cd") %>%
  row_spec(which(genes_assessment$Genes_Status == "Good"), background = "#d1ecf1") %>%
  row_spec(which(genes_assessment$Genes_Status == "Excellent"), background = "#d4edda")
```

### Troubleshooting Low Gene Detection

**Technical Issues:**
- Insufficient sequencing depth (limits detection of low-abundance transcripts)
- High sequencing saturation with low UMIs (re-sequencing same molecules instead of discovering new genes)
- Probe panel issues (degraded probes, batch effects)

**Biological Factors:**
- Tissue regions with low transcriptional activity
- Cell-type specific issues (some cell types have lower transcriptional diversity)
- Severe RNA degradation (affects low-abundance transcripts disproportionately)

---

## 3. Reads Confidently Mapped to Probe Set

### Technical Definition

**Molecular Process:** After sequencing, Space Ranger aligns reads to the probe set reference. "Confidently mapped" reads are those that: (1) align uniquely to a single probe sequence with high quality (MAPQ ≥ 30), (2) match the expected probe structure (correct spatial barcode, UMI, and probe sequence), and (3) are not ambiguous multi-mappers.

**What This Metric Measures:** The percentage of total sequencing reads that successfully map to designed probe sequences with high confidence. This reflects the specificity and purity of the spatial library.

**Technical Components:**
- **Spatial Barcode Recognition:** Reads must contain a valid spatial barcode from the capture array (4,992 possible positions)
- **Probe Sequence Matching:** The RNA-derived sequence must align to a known probe target
- **UMI Quality:** UMI sequence must meet quality thresholds
- **Mapping Quality:** Alignment score must indicate unique, high-quality mapping

**Failure Modes:**
- **Low mapping (<50%):** Indicates severe library contamination, wrong probe set reference, or technical failure
- **Moderate mapping (50-70%):** Suggests contamination with off-target sequences, ribosomal RNA, genomic DNA, or degraded library components
- **High mapping (>85%):** Indicates clean, specific library with minimal off-target content

### Quality Thresholds

Based on 10x Genomics CG000495:

- **Excellent:** >85% confidently mapped
- **Good:** 70-85% confidently mapped
- **Marginal:** 50-70% confidently mapped
- **Failed:** <50% confidently mapped

```{r confident-mapping}
metrics$Confident.Mapping.Pct <- metrics$Reads.Mapped.Confidently.to.Probe.Set * 100

p3 <- ggplot(metrics, aes(x = reorder(Sample.ID, Confident.Mapping.Pct), 
                           y = Confident.Mapping.Pct, fill = Sample.ID)) +
  geom_bar(stat = "identity", show.legend = FALSE) +
  geom_hline(yintercept = 85, linetype = "dashed", color = "darkgreen", size = 1) +
  geom_hline(yintercept = 70, linetype = "dashed", color = "orange", size = 1) +
  geom_hline(yintercept = 50, linetype = "dashed", color = "red", size = 1) +
  geom_text(aes(label = paste0(round(Confident.Mapping.Pct, 1), "%")), 
            vjust = -0.5, size = 3) +
  labs(title = "Reads Confidently Mapped to Probe Set",
       subtitle = "Green = 85% (Excellent) | Orange = 70% (Good) | Red = 50% (Marginal)",
       x = "Sample", y = "% Confidently Mapped") +
  ylim(0, 100) +
  theme_minimal() +
  theme(axis.text.x = element_text(angle = 45, hjust = 1))

ggplotly(p3)
```

```{r mapping-assessment}
mapping_assessment <- metrics %>%
  mutate(
    Mapping_Status = case_when(
      Confident.Mapping.Pct >= 85 ~ "Excellent",
      Confident.Mapping.Pct >= 70 ~ "Good",
      Confident.Mapping.Pct >= 50 ~ "Marginal",
      TRUE ~ "Failed"
    )
  ) %>%
  select(Sample.ID, Confident.Mapping.Pct, Mapping_Status)

kable(mapping_assessment, 
      col.names = c("Sample", "% Confidently Mapped", "Status"),
      align = c("l", "r", "l")) %>%
  kable_styling(bootstrap_options = c("striped", "hover")) %>%
  row_spec(which(mapping_assessment$Mapping_Status == "Failed"), background = "#f8d7da") %>%
  row_spec(which(mapping_assessment$Mapping_Status == "Marginal"), background = "#fff3cd") %>%
  row_spec(which(mapping_assessment$Mapping_Status == "Good"), background = "#d1ecf1") %>%
  row_spec(which(mapping_assessment$Mapping_Status == "Excellent"), background = "#d4edda")
```

### Troubleshooting Low Confident Mapping

**Contamination Sources:**
- **Genomic DNA:** Incomplete protease digestion leaves DNA that can be captured by probes
- **Ribosomal RNA:** Not depleted in FFPE workflows, can dominate if mRNA levels are very low
- **Ambient RNA:** Cross-contamination between samples or from reagents
- **Index hopping:** Barcode misassignment during sequencing (typically <2% on newer sequencers)

**Reference Issues:**
- Wrong probe set selected during Space Ranger analysis
- Incorrect species reference
- Custom probe panel without updated reference

**Technical Failures:**
- Poor probe ligation efficiency (creates incomplete probe products that don't map)
- Degraded probe pool
- Library quality control failure (too many short fragments, adapter dimers)

---

## 4. Split-Mapped Reads

### Technical Definition

**Molecular Process:** In probe-based Visium FFPE, probes are designed as pairs that hybridize to adjacent regions of target mRNA sequences. A "split-mapped" read occurs when the sequenced fragment spans the junction between two probe pair components, requiring the aligner to split the read into two segments that map to different genomic locations (typically different exons of the same gene).

**What This Metric Measures:** The fraction of reads that map in a split fashion across probe pair junctions or exon boundaries. For probe-based detection, this primarily captures reads spanning the designed probe pair gap.

**Expected Values:** For FFPE probe-based assays, split-mapped reads are typically low (1-10%) because:
1. Probes are designed to capture RNA fragments, not full-length transcripts
2. FFPE RNA is already fragmented, reducing likelihood of capturing splice junctions
3. Most reads capture a single probe segment

**Interpretation:**
- **Very low (<1%):** Normal for highly fragmented FFPE RNA
- **Low (1-10%):** Typical range for FFPE probe assays
- **Elevated (10-50%):** May indicate better-preserved RNA or specific probe design effects
- **Very high (>50%):** Unusual for FFPE; possible genomic DNA contamination or analysis artifact

### Quality Thresholds

- **Normal:** <10% split-mapped
- **Acceptable:** 10-30% split-mapped
- **Investigate:** >30% split-mapped

```{r split-mapped}
metrics$Split.Mapped.Pct <- metrics$Reads.Split.Mapped.to.Probe.Set * 100

p4 <- ggplot(metrics, aes(x = reorder(Sample.ID, Split.Mapped.Pct), 
                           y = Split.Mapped.Pct, fill = Sample.ID)) +
  geom_bar(stat = "identity", show.legend = FALSE) +
  geom_hline(yintercept = 10, linetype = "dashed", color = "blue", size = 1) +
  geom_hline(yintercept = 30, linetype = "dashed", color = "orange", size = 1) +
  geom_text(aes(label = paste0(round(Split.Mapped.Pct, 1), "%")), 
            vjust = -0.5, size = 3) +
  labs(title = "Split-Mapped Reads",
       subtitle = "Blue = 10% (typical upper range) | Orange = 30% (investigate)",
       x = "Sample", y = "% Split-Mapped") +
  theme_minimal() +
  theme(axis.text.x = element_text(angle = 45, hjust = 1))

ggplotly(p4)
```

```{r split-stats}
data.frame(
  Metric = c("Mean", "Median", "Min", "Max"),
  Value = paste0(c(
    round(mean(metrics$Split.Mapped.Pct), 2),
    round(median(metrics$Split.Mapped.Pct), 2),
    round(min(metrics$Split.Mapped.Pct), 2),
    round(max(metrics$Split.Mapped.Pct), 2)
  ), "%")
) %>%
  kable() %>%
  kable_styling(bootstrap_options = c("striped", "hover"), full_width = FALSE)
```

**Note:** Split-mapped read percentages in FFPE are typically less informative than in fresh frozen whole transcriptome assays. Very high values (>50%) warrant investigation for possible genomic DNA contamination or technical artifacts, but moderate values (10-30%) are not necessarily problematic.

---

## 5. Sequencing Saturation

### Technical Definition

**Molecular Process:** Sequencing saturation measures the degree to which the library has been "exhausted" - i.e., the fraction of sequencing reads that are PCR duplicates of already-sequenced molecules rather than new unique molecules. It is calculated as: 1 - (unique UMIs / total reads mapping to spots).

**What This Metric Measures:** How thoroughly the captured molecular library has been sequenced. At low saturation, each additional sequencing read has high probability of detecting a new molecule. At high saturation, most reads are duplicates, providing minimal new information.

**Calculation Details:** For a spot with 1,000 total reads that collapse to 200 unique UMIs, saturation = 1 - (200/1,000) = 80%. This means 80% of reads were PCR duplicates that provided no additional molecular information.

**Biological and Technical Interpretation:**
- **High saturation (>90%) with high UMIs (>1,000):** Excellent - library is deeply sequenced, captures most available molecules
- **High saturation (>90%) with low UMIs (<500):** Problematic - re-sequencing a limited pool of molecules; more sequencing won't help
- **Low saturation (<70%):** Under-sequenced - additional sequencing depth would detect more unique molecules

**FFPE-Specific Context:** FFPE samples with degraded RNA often reach high saturation at lower sequencing depths than fresh frozen because there are fewer intact molecules to capture. High saturation does not guarantee good data quality - it must be interpreted alongside UMI and gene counts.

### Quality Thresholds

- **Optimal:** 70-95% saturation
- **Under-sequenced:** <70% saturation (more sequencing beneficial)
- **Adequate:** >95% saturation (diminishing returns from additional sequencing)

```{r seq-saturation}
metrics$Seq.Saturation.Pct <- metrics$Sequencing.Saturation * 100

p5 <- ggplot(metrics, aes(x = reorder(Sample.ID, Seq.Saturation.Pct), 
                           y = Seq.Saturation.Pct, fill = Sample.ID)) +
  geom_bar(stat = "identity", show.legend = FALSE) +
  geom_hline(yintercept = 70, linetype = "dashed", color = "orange", size = 1) +
  geom_hline(yintercept = 95, linetype = "dashed", color = "blue", size = 1) +
  geom_text(aes(label = paste0(round(Seq.Saturation.Pct, 1), "%")), 
            vjust = -0.5, size = 3) +
  labs(title = "Sequencing Saturation",
       subtitle = "Orange = 70% (minimum) | Blue = 95% (plateau)",
       x = "Sample", y = "% Sequencing Saturation") +
  ylim(0, 100) +
  theme_minimal() +
  theme(axis.text.x = element_text(angle = 45, hjust = 1))

ggplotly(p5)
```

```{r saturation-stats}
data.frame(
  Metric = c("Mean", "Median", "Min", "Max"),
  Value = paste0(c(
    round(mean(metrics$Seq.Saturation.Pct), 1),
    round(median(metrics$Seq.Saturation.Pct), 1),
    round(min(metrics$Seq.Saturation.Pct), 1),
    round(max(metrics$Seq.Saturation.Pct), 1)
  ), "%")
) %>%
  kable() %>%
  kable_styling(bootstrap_options = c("striped", "hover"), full_width = FALSE)
```

### Critical Interpretation

```{r saturation-umi-relationship}
# Identify problematic pattern: high saturation + low UMIs
problematic_saturation <- metrics %>%
  filter(Seq.Saturation.Pct > 90 & Median.UMI.Counts.per.Spot < 500) %>%
  select(Sample.ID, Seq.Saturation.Pct, Median.UMI.Counts.per.Spot)

if(nrow(problematic_saturation) > 0) {
  cat("**WARNING: Samples with high saturation but low UMI counts:**nn")
  cat("These samples are re-sequencing a limited molecular pool. Additional sequencing will NOT improve data quality. Issues likely stem from poor RNA quality, capture efficiency, or tissue quality.nn")
  kable(problematic_saturation, 
        col.names = c("Sample", "Saturation %", "Median UMI/Spot")) %>%
    kable_styling(bootstrap_options = c("striped", "hover"))
}
```

---

## 6. Mean Reads per Spot

### Technical Definition

**Molecular Process:** During sequencing, each spot's captured library is sequenced to generate millions of reads across the entire slide. After demultiplexing and alignment, reads are assigned to individual spots based on their spatial barcode. This metric reports the average number of sequencing reads assigned to spots under tissue.

**What This Metric Measures:** Sequencing depth allocated per spatial location. Higher read counts increase the likelihood of detecting low-abundance transcripts but show diminishing returns once saturation is reached.

**Biological Interpretation:** Required read depth depends on:
1. RNA content per spot (cell density, transcriptional activity)
2. RNA quality (degraded samples need more reads to achieve same UMI detection)
3. Desired sensitivity (detecting rare transcripts requires higher depth)
4. Library complexity (number of unique molecules captured)

**FFPE Considerations:** FFPE samples may require higher read depth than fresh frozen to achieve similar UMI detection due to reduced capture efficiency and higher background. However, if RNA is severely degraded, additional reads provide minimal benefit.

### Quality Thresholds

Based on 10x Genomics recommendations (CG000408):

- **Excellent:** >50,000 reads/spot
- **Good:** 25,000-50,000 reads/spot
- **Adequate:** 15,000-25,000 reads/spot
- **Under-sequenced:** <15,000 reads/spot

```{r mean-reads}
p6 <- ggplot(metrics, aes(x = reorder(Sample.ID, Mean.Reads.per.Spot), 
                           y = Mean.Reads.per.Spot, fill = Sample.ID)) +
  geom_bar(stat = "identity", show.legend = FALSE) +
  geom_hline(yintercept = 50000, linetype = "dashed", color = "darkgreen", size = 1) +
  geom_hline(yintercept = 25000, linetype = "dashed", color = "blue", size = 1) +
  geom_hline(yintercept = 15000, linetype = "dashed", color = "orange", size = 1) +
  geom_text(aes(label = format(round(Mean.Reads.per.Spot, 0), big.mark = ",")), 
            vjust = -0.5, size = 3) +
  labs(title = "Mean Reads per Spot",
       subtitle = "Green = 50K (Excellent) | Blue = 25K (Good) | Orange = 15K (Adequate)",
       x = "Sample", y = "Mean Reads") +
  scale_y_continuous(labels = scales::comma) +
  theme_minimal() +
  theme(axis.text.x = element_text(angle = 45, hjust = 1))

ggplotly(p6)
```

```{r reads-stats}
data.frame(
  Metric = c("Mean", "Median", "Min", "Max"),
  Value = format(c(
    round(mean(metrics$Mean.Reads.per.Spot), 0),
    round(median(metrics$Mean.Reads.per.Spot), 0),
    round(min(metrics$Mean.Reads.per.Spot), 0),
    round(max(metrics$Mean.Reads.per.Spot), 0)
  ), big.mark = ",")
) %>%
  kable() %>%
  kable_styling(bootstrap_options = c("striped", "hover"), full_width = FALSE)
```

### Sequencing Efficiency Assessment

```{r sequencing-efficiency}
# Calculate UMIs per 1000 reads as efficiency metric
metrics$UMI_per_1K_reads <- (metrics$Median.UMI.Counts.per.Spot / metrics$Mean.Reads.per.Spot) * 1000

efficiency_table <- metrics %>%
  select(Sample.ID, Mean.Reads.per.Spot, Median.UMI.Counts.per.Spot, UMI_per_1K_reads) %>%
  arrange(desc(UMI_per_1K_reads))

kable(efficiency_table,
      col.names = c("Sample", "Mean Reads/Spot", "Median UMI/Spot", "UMIs per 1K Reads"),
      digits = c(0, 0, 0, 1),
      format.args = list(big.mark = ",")) %>%
  kable_styling(bootstrap_options = c("striped", "hover"))
```

**Interpretation:** UMIs per 1,000 reads indicates library quality. Higher values suggest better RNA quality and capture efficiency. Typical FFPE values: 15-50 UMIs per 1K reads.

---

## 7. Number of Spots Under Tissue

### Technical Definition

**Molecular Process:** The Visium slide contains 4,992 barcoded spots arranged in a hexagonal grid with 100μm center-to-center spacing. Each spot is 55μm in diameter and contains millions of capture oligonucleotides. During image analysis, Space Ranger aligns the H&E tissue image to the spot grid and identifies which spots contain tissue versus empty space.

**What This Metric Measures:** The total count of spots that Space Ranger classified as being covered by tissue based on automated or manual tissue detection. This reflects tissue size, tissue placement on the slide, and accuracy of tissue detection.

**Biological Interpretation:** 
- **Typical tissue sections:** 3,000-5,000 spots (varies by tissue size and placement)
- **Small biopsies/cores:** 500-2,000 spots
- **Large sections:** Can approach full slide coverage (4,992 spots)

**Technical Considerations:** 
- Spots classified as "under tissue" receive preferential analysis
- Poor tissue detection can exclude valid tissue regions or include background
- Tissue folding, tears, or air bubbles can affect spot classification

### Quality Assessment

This metric is primarily informational - sample quality is not determined by tissue size. However:

- **Verify tissue detection:** Check web summary images to confirm accurate tissue segmentation
- **Small spot counts (<1,000):** Ensure sufficient statistical power for downstream analysis
- **Unusually low counts:** May indicate tissue loss during processing or poor slide adhesion

```{r spots-under-tissue}
p7 <- ggplot(metrics, aes(x = reorder(Sample.ID, Number.of.Spots.Under.Tissue), 
                           y = Number.of.Spots.Under.Tissue, fill = Sample.ID)) +
  geom_bar(stat = "identity", show.legend = FALSE) +
  geom_hline(yintercept = 3000, linetype = "dashed", color = "blue", size = 1) +
  geom_text(aes(label = format(Number.of.Spots.Under.Tissue, big.mark = ",")), 
            vjust = -0.5, size = 3) +
  labs(title = "Number of Spots Under Tissue",
       subtitle = "Blue line = 3,000 (typical minimum for full sections)",
       x = "Sample", y = "Number of Spots") +
  scale_y_continuous(labels = scales::comma) +
  theme_minimal() +
  theme(axis.text.x = element_text(angle = 45, hjust = 1))

ggplotly(p7)
```

```{r spots-stats}
data.frame(
  Metric = c("Mean", "Median", "Min", "Max"),
  Value = format(c(
    round(mean(metrics$Number.of.Spots.Under.Tissue), 0),
    round(median(metrics$Number.of.Spots.Under.Tissue), 0),
    round(min(metrics$Number.of.Spots.Under.Tissue), 0),
    round(max(metrics$Number.of.Spots.Under.Tissue), 0)
  ), big.mark = ",")
) %>%
  kable() %>%
  kable_styling(bootstrap_options = c("striped", "hover"), full_width = FALSE)
```

---

## 8. Genes Detected

### Technical Definition

**Molecular Process:** Across all spots in the sample, Space Ranger counts how many unique gene IDs from the probe panel have at least one UMI detected anywhere on the tissue. This is a sample-level metric, not spot-level.

**What This Metric Measures:** The breadth of transcriptional detection across the entire tissue section. A comprehensive probe panel targets ~18,000-19,000 genes, but not all genes are expressed in every tissue type or preserved in every FFPE sample.

**Biological Interpretation:**
- Gene detection depends on tissue type (brain expresses ~15,000 genes; liver ~12,000)
- Cell type diversity increases gene detection
- Tissue-specific genes may not be in detection range if tissue is homogeneous
- Low-abundance tissue-restricted genes may not be detected even if present

**FFPE-Specific Factors:**
- RNA degradation preferentially affects low-abundance transcripts
- Extended fixation reduces detection of weakly expressed genes
- Probe accessibility issues may prevent detection of some targets
- Background noise can reduce sensitivity for rare transcripts

### Quality Thresholds

Based on human tissues with standard probe panels:

- **Excellent:** >16,000 genes detected
- **Good:** 14,000-16,000 genes detected
- **Marginal:** 12,000-14,000 genes detected
- **Poor:** <12,000 genes detected

```{r genes-detected}
p8 <- ggplot(metrics, aes(x = reorder(Sample.ID, Genes.Detected), 
                           y = Genes.Detected, fill = Sample.ID)) +
  geom_bar(stat = "identity", show.legend = FALSE) +
  geom_hline(yintercept = 16000, linetype = "dashed", color = "darkgreen", size = 1) +
  geom_hline(yintercept = 14000, linetype = "dashed", color = "orange", size = 1) +
  geom_hline(yintercept = 12000, linetype = "dashed", color = "red", size = 1) +
  geom_text(aes(label = format(Genes.Detected, big.mark = ",")), 
            vjust = -0.5, size = 3) +
  labs(title = "Total Genes Detected",
       subtitle = "Green = 16K (Excellent) | Orange = 14K (Good) | Red = 12K (Marginal)",
       x = "Sample", y = "Genes Detected") +
  scale_y_continuous(labels = scales::comma) +
  theme_minimal() +
  theme(axis.text.x = element_text(angle = 45, hjust = 1))

ggplotly(p8)
```

```{r genes-detected-assessment}
genes_detected_assessment <- metrics %>%
  mutate(
    GenesDetected_Status = case_when(
      Genes.Detected >= 16000 ~ "Excellent",
      Genes.Detected >= 14000 ~ "Good",
      Genes.Detected >= 12000 ~ "Marginal",
      TRUE ~ "Poor"
    )
  ) %>%
  select(Sample.ID, Genes.Detected, GenesDetected_Status)

kable(genes_detected_assessment, 
      col.names = c("Sample", "Genes Detected", "Status"),
      align = c("l", "r", "l"),
      format.args = list(big.mark = ",")) %>%
  kable_styling(bootstrap_options = c("striped", "hover")) %>%
  row_spec(which(genes_detected_assessment$GenesDetected_Status == "Poor"), background = "#f8d7da") %>%
  row_spec(which(genes_detected_assessment$GenesDetected_Status == "Marginal"), background = "#fff3cd") %>%
  row_spec(which(genes_detected_assessment$GenesDetected_Status == "Good"), background = "#d1ecf1") %>%
  row_spec(which(genes_detected_assessment$GenesDetected_Status == "Excellent"), background = "#d4edda")
```

```{r genes-detected-stats}
data.frame(
  Metric = c("Mean", "Median", "Min", "Max"),
  Value = format(c(
    round(mean(metrics$Genes.Detected), 0),
    round(median(metrics$Genes.Detected), 0),
    round(min(metrics$Genes.Detected), 0),
    round(max(metrics$Genes.Detected), 0)
  ), big.mark = ",")
) %>%
  kable() %>%
  kable_styling(bootstrap_options = c("striped", "hover"), full_width = FALSE)
```

---

# Integrated Quality Assessment

```{r integrated-assessment}
# Calculate comprehensive quality scores with FFPE-appropriate thresholds
quality_assessment <- metrics %>%
  mutate(
    # UMI scoring (most critical for FFPE)
    UMI_score = case_when(
      Median.UMI.Counts.per.Spot >= 2000 ~ 3,
      Median.UMI.Counts.per.Spot >= 1000 ~ 2,
      Median.UMI.Counts.per.Spot >= 500 ~ 1,
      TRUE ~ 0
    ),
    # Genes scoring
    Genes_score = case_when(
      Median.Genes.per.Spot >= 1500 ~ 3,
      Median.Genes.per.Spot >= 1000 ~ 2,
      Median.Genes.per.Spot >= 500 ~ 1,
      TRUE ~ 0
    ),
    # Mapping scoring
    Mapping_score = case_when(
      Confident.Mapping.Pct >= 85 ~ 3,
      Confident.Mapping.Pct >= 70 ~ 2,
      Confident.Mapping.Pct >= 50 ~ 1,
      TRUE ~ 0
    ),
    # Reads scoring
    Reads_score = case_when(
      Mean.Reads.per.Spot >= 50000 ~ 3,
      Mean.Reads.per.Spot >= 25000 ~ 2,
      Mean.Reads.per.Spot >= 15000 ~ 1,
      TRUE ~ 0
    ),
    # Genes detected scoring
    GenesDetected_score = case_when(
      Genes.Detected >= 16000 ~ 3,
      Genes.Detected >= 14000 ~ 2,
      Genes.Detected >= 12000 ~ 1,
      TRUE ~ 0
    ),
    # Total score (max 15)
    Total_Score = UMI_score + Genes_score + Mapping_score + Reads_score + GenesDetected_score,
    # Quality classification
    Quality_Grade = case_when(
      Total_Score >= 12 ~ "Excellent",
      Total_Score >= 9 ~ "Good",
      Total_Score >= 6 ~ "Marginal",
      TRUE ~ "Failed"
    ),
    # Usability recommendation
    Recommendation = case_when(
      Quality_Grade == "Excellent" ~ "Proceed with analysis",
      Quality_Grade == "Good" ~ "Usable with caution",
      Quality_Grade == "Marginal" ~ "Limited utility - consider re-processing",
      TRUE ~ "Do not use - technical failure"
    )
  )

quality_summary <- quality_assessment %>%
  select(Sample.ID, 
         Median.UMI.Counts.per.Spot,
         Median.Genes.per.Spot,
         Confident.Mapping.Pct,
         Total_Score, 
         Quality_Grade,
         Recommendation)

kable(quality_summary,
      col.names = c("Sample", "Median UMI", "Median Genes", "% Mapped", "Score (of 15)", "Grade", "Recommendation"),
      digits = c(0, 0, 0, 1, 0, 0, 0)) %>%
  kable_styling(bootstrap_options = c("striped", "hover"), font_size = 12) %>%
  row_spec(which(quality_summary$Quality_Grade == "Failed"), background = "#f8d7da", bold = TRUE) %>%
  row_spec(which(quality_summary$Quality_Grade == "Marginal"), background = "#fff3cd") %>%
  row_spec(which(quality_summary$Quality_Grade == "Good"), background = "#d1ecf1") %>%
  row_spec(which(quality_summary$Quality_Grade == "Excellent"), background = "#d4edda")
```

---

# Critical Findings Summary

```{r critical-findings, results='asis'}
# Identify failed samples
failed_samples <- quality_assessment %>%
  filter(Quality_Grade == "Failed") %>%
  pull(Sample.ID)

marginal_samples <- quality_assessment %>%
  filter(Quality_Grade == "Marginal") %>%
  pull(Sample.ID)

good_samples <- quality_assessment %>%
  filter(Quality_Grade %in% c("Good", "Excellent")) %>%
  pull(Sample.ID)

# Report findings
if(length(failed_samples) > 0) {
  cat("## FAILED SAMPLES\n\n")
  cat("The following samples failed quality control and should NOT be used for analysis:\n\n")
  for(s in failed_samples) {
    cat(paste0("- ", s, "\n"))
  }
  cat("\n")
  
  # Provide specific failure reasons
  for(sample in failed_samples) {
    sample_data <- quality_assessment %>% filter(Sample.ID == sample)
    cat(paste0("### ", sample, " failure reasons:\n\n"))
    
    if(sample_data$UMI_score == 0) {
      cat(paste0("- Critically low UMI counts (", round(sample_data$Median.UMI.Counts.per.Spot, 0), " per spot)\n"))
    }
    if(sample_data$Genes_score == 0) {
      cat(paste0("- Critically low gene detection (", round(sample_data$Median.Genes.per.Spot, 0), " per spot)\n"))
    }
    if(sample_data$Mapping_score == 0) {
      cat(paste0("- Poor mapping quality (", round(sample_data$Confident.Mapping.Pct, 1), "% confidently mapped)\n"))
    }
    cat("\n")
  }
}

if(length(marginal_samples) > 0) {
  cat("## MARGINAL SAMPLES\n\n")
  cat("The following samples have marginal quality. Use with extreme caution:\n\n")
  for(s in marginal_samples) {
    cat(paste0("- ", s, "\n"))
  }
  cat("\n")
}

if(length(good_samples) > 0) {
  cat("## USABLE SAMPLES\n\n")
  cat("The following samples passed quality control:\n\n")
  for(s in good_samples) {
    cat(paste0("- ", s, "\n"))
  }
  cat("\n")
}

# Overall dataset assessment
pass_rate <- (length(good_samples) / n_samples) * 100
cat(paste0("**Overall Pass Rate:** ", round(pass_rate, 1), "% (", length(good_samples), " of ", n_samples, " samples)\n\n"))

if(pass_rate < 50) {
  cat("**CRITICAL ALERT:** More than half of samples failed QC. This suggests systematic issues with:\n\n")
  cat("- FFPE tissue quality (over-fixation, poor storage, degraded blocks)\n\n")
  cat("- Technical processing (inadequate deparaffinization, insufficient protease treatment)\n\n")
  cat("- Library preparation issues (probe degradation, poor ligation efficiency)\n\n")
  cat("- Sample handling (freeze-thaw cycles, contamination)\n\n")
  cat("Recommend reviewing entire processing workflow before proceeding.\n\n")
}
```

---

# Sample-Specific Recommendations

```{r sample-recommendations, results='asis'}
for(i in 1:nrow(quality_assessment)) {
  sample_data <- quality_assessment[i,]
  
  cat(paste0("## ", sample_data$Sample.ID, "\n\n"))
  cat(paste0("**Overall Grade:** ", sample_data$Quality_Grade, " (Score: ", sample_data$Total_Score, "/15)\n\n"))
  
  # UMI assessment
  if(sample_data$UMI_score == 3) {
    cat("- UMI Count: EXCELLENT - Sufficient molecular capture\n")
  } else if(sample_data$UMI_score == 2) {
    cat("- UMI Count: GOOD - Adequate molecular capture\n")
  } else if(sample_data$UMI_score == 1) {
    cat("- UMI Count: MARGINAL - Low molecular capture may limit sensitivity\n")
  } else {
    cat("- UMI Count: FAILED - Insufficient molecular capture for reliable analysis\n")
  }
  
  # Genes assessment
  if(sample_data$Genes_score == 3) {
    cat("- Gene Detection: EXCELLENT - High transcriptional complexity captured\n")
  } else if(sample_data$Genes_score == 2) {
    cat("- Gene Detection: GOOD - Adequate transcriptional complexity\n")
  } else if(sample_data$Genes_score == 1) {
    cat("- Gene Detection: MARGINAL - Limited transcriptional diversity\n")
  } else {
    cat("- Gene Detection: FAILED - Insufficient gene diversity for analysis\n")
  }
  
  # Mapping assessment
  if(sample_data$Mapping_score == 3) {
    cat("- Mapping Quality: EXCELLENT - High library specificity\n")
  } else if(sample_data$Mapping_score == 2) {
    cat("- Mapping Quality: GOOD - Acceptable library specificity\n")
  } else if(sample_data$Mapping_score == 1) {
    cat("- Mapping Quality: MARGINAL - Possible contamination or technical issues\n")
  } else {
    cat("- Mapping Quality: FAILED - Severe contamination or wrong reference\n")
  }
  
  # Sequencing depth assessment
  if(sample_data$Reads_score >= 2) {
    cat("- Sequencing Depth: Adequate\n")
  } else {
    cat("- Sequencing Depth: Under-sequenced - additional reads may improve detection\n")
  }
  
  # Overall recommendation
  cat(paste0("\n**Recommendation:** ", sample_data$Recommendation, "\n\n"))
  
  cat("---\n\n")
}
```

---

# Technical Reference and Thresholds

## Threshold Justification

All quality thresholds in this report are based on:

1. **10x Genomics Technical Note CG000408 Rev C:** "Visium Spatial Gene Expression Reagent Kits for FFPE - User Guide"
   - Recommended read depth: 25,000-50,000 reads per spot
   - Expected UMI range: 1,000-5,000 per spot for quality FFPE samples

2. **10x Genomics Technical Note CG000495:** "Interpreting Space Ranger Web Summary Files for Visium Spatial Gene Expression for FFPE"
   - Mapping thresholds: >70% confidently mapped to probe set
   - Sequencing saturation: 70-95% optimal range

3. **Published FFPE Visium Studies:**
   - Janesick et al. 2022, bioRxiv: FFPE optimization showing 800-3,000 median UMI/spot across various tissues and conditions
   - He et al. 2023, Nature Methods: FFPE protocol validation with median UMI/spot ranging 1,200-4,500

4. **10x Genomics Public Datasets:**
   - Human breast cancer FFPE: ~2,500 median UMI/spot
   - Human kidney FFPE: ~1,800 median UMI/spot
   - Mouse brain FFPE: ~2,200 median UMI/spot

## Key Differences from Fresh Frozen

FFPE samples typically show:
- **50-70% reduction** in UMI counts vs fresh frozen
- **Higher sequencing saturation** at lower UMI counts
- **Reduced gene detection** especially for low-abundance transcripts
- **Greater sample-to-sample variability** due to fixation differences

## When to Re-process

Consider re-processing if:
1. Median UMI/spot <500 AND high sequencing saturation (>90%)
2. Confident mapping <50%
3. Multiple samples from same tissue block show poor quality (suggests block-level issues)

---

# Session Information

```{r session-info}
sessionInfo()
```
